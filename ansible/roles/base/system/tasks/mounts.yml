---
- name: >
    main
    : Install LVM
  package:
    name: "{{ lvm_package[ ansible_facts.os_family ] }}"
    state: present
  become: True

- name: >
    main
    : Scan for LVs
  command: lvscan
  become: True
  changed_when: False

- name: >
    mounts
    : Ensure Mount Directories
  file:
    path: "{{ item.dest }}"
    state: directory
  loop: "{{ mounts }}"
  become: True

- name: >
    mounts
    : Mount Lines in fstab
  lineinfile:
    path: /etc/fstab
    line: >-
      {{ item.src }}
      {{ item.dest }}
      {{ item.type|default("ext4") }}
      {{ item.options|default("defaults") }}
      0 0
  loop: "{{ mounts }}"
  become: True

- name: >
    mounts
    : Mount Devices to Mountpoints
  command: mount {{ item.dest }}
  loop: "{{ mounts }}"
  become: True
  register: out
  changed_when: out.rc == 0
  failed_when: >
    out.failed
    and "already mounted" not in out.stderr
