---
- set_fact:
    static_isolated_hosts: >-
        { {% for sys_name, sys_data in (hostvars|key_match_filter("hardware", "protectli")).items() %}
              {% set sys_loop = loop %}
              {% if sys_name != inventory_hostname %}
                  {% set sys_prefix = sys_name + '.' %}
              {% else %}{% set sys_prefix = "" %}
              {% endif %}
              {% for net_name, net in sys_data.networks.items() %}
                  {% set net_loop = loop %}
                  {% for host_info in net.hosts|default([]) %}
                      {% set cidr = net.cidr | ipsubnet(30, loop.index) %}
                      "{{ sys_prefix }}{{ host_info.name }}": {
                          "system": "{{ sys_name }}",
                          "network_name": "{{ net_name }}",
                          "isolation_subnet_cidr": "{{ cidr }}",
                          "gateway": "{{ cidr | ipmath(1) }}",
                          "ip": "{{ cidr | ipmath(2) }}",
                          "hwaddr": "{{ host_info.hwaddr }}"
                      }{% if not (sys_loop.last and net_loop.last and loop.last) %},{% endif %}
                  {% endfor %}
              {% endfor %}
          {% endfor %}
        }

- set_fact:
    target_ips: >-
        {
          {% for name, info in static_isolated_hosts.items() %}
                  "{{ name }}": "{{ info.ip }}",
          {% endfor %}
          {% for net_name, net_info in networks.items() %}
              "{{ net_name }}": "{{ net_info.cidr }}"{% if not loop.last %},{% endif %}
          {% endfor %}
        }

- debug:
    msg: |
      {{ static_isolated_hosts }}
